<p>Cabal dependency hell has been around for a while now, and it has especially caused issues for larger projects with lots of dependencies (e.g., Yesod). We've put a lot of effort into finding ways to avoid it, but we've still be plagued by problems. This has had the effect of both hindering existing users, and preventing new users from being able to use Yesod.</p>
<p>Fortunately, the answer is simple: to avoid hell, you just need to find <a href="https://github.com/snoyberg/cabal-nirvana">nirvana</a>. (Note: There have been two very large discussions on this issue recently, one on <a href="http://groups.google.com/group/yesodweb/browse_thread/thread/e1b6a9e867933b59">the Yesod mailing list</a> and another on <a href="https://plus.google.com/116553865628071717889/posts/WFPfB3M5C1Q">Google+</a>. The discussions there may help explain some of the motivations if you're left wanting more at the end of this blog post.)</p>
<h2 id="the-problem">The problem</h2>
<p>Simply stated, Hackage is a zoo. Anyone can upload anything at any time. If I write some code that depends on foobar version 0.1, and someone comes along and makes a breaking change in 0.1.1, my code will (generally) break. We also have the issue of different packages using different versions of the same underlying packages (e.g., baz requires foobar 0.1, and bin requires foobar 0.2), and therefore they cannot be installed side-by-side.</p>
<p>Distributions, such as Debian, Nix, and Fedora, need to solve this problem themselves by hand-selecting which packages will be included. This solves the problem completely, but is relatively labor intensive. The bigger problem is that <em>everyone is solving the same problem separately</em>. Also, this work only benefits people using distributions for installing their software; normal cabal users are still left with the wild west.</p>
<p>I say none of this &quot;zoo&quot; and &quot;wild west&quot; stuff as an affront to Hackage: Hackage is exactly as it should be, and I don't wish to change it. The problem is, we need an extra layer to provide more stability.</p>
<h2 id="the-solution">The solution</h2>
<p>There's an obvious solution to the problem as stated: have a centralized list of stable/compatible/blessed packages, and have everyone use it. Making that list is an important issue, and one I'm hoping to engage the community on. But assuming we had that list, all the distributions could use it, and we'd have a much nicer stable system.</p>
<p>But we still need one more thing: a solution for cabal users. That's where cabal-nirvana comes in. It's an incredibly simple (101 sloc at last count) program that adds a bunch of version constraints to you cabal config file. It gets the list of necessary constraints from some site (currently I set up a basic one for Yesod at: www.snoyman.com/cabal-nirvana/yesod, which is being used as the default). That way, you will never get dependency hell on the packages covered by the list.</p>
<p>I've just uploaded the first version to Hackage (warning: alpha quality software). To get started, you can use the commands:</p>
<pre><code>cabal install cabal-nirvana
cabal-nirvana fetch # get the most recent list of blessed packages
cabal-nirvana start # apply the downloaded list to your config file
</code></pre>
<p>Two other commands are <code>stop</code> (remove all constraints) and <code>test</code>, which will try (via <code>cabal-dev</code>) to install all of the packages in your config file simultaneously.</p>
<p>I've written cabal-nirvana with all of the bad practices I normally fight against: it uses String instead of Text or ByteString, uses the HTTP package instead of http-conduit, and uses the standard <code>type FilePath = [Char]</code> instead of <a href="http://hackage.haskell.org/package/system-filepath">system-filepath</a>. The reason is simple: we want to have the barest number of dependencies possible, to make sure our cabal-hell-defeater is not itself defeated by cabal hell.</p>
<p>The repo also has another (optional) executable to help you generate one of these lists of blessed packages. You give it a list of packages you want covered, and it will generate a list of all of the deep dependencies, together with the most recent version of them available from Hackage. After generating this file, you should use <code>cabal-nirvana test</code> on it to confirm that this is a compatible list. To build this executable (cabal-nirvana-generate), pass in the -fgenerate option when building.</p>
<h2 id="whats-next">What's next</h2>
<p>This is a very preliminary release, mostly intended to start getting feedback and working to a real solution. Some thoughts I've had is that we should have built-in support for different stability profiles (stable, beta, alpha, bleeding), and automatically detect the GHC version and switch lists appropriately.</p>
<p>If you're out there using Yesod, please give this tool a try and let me know if it solves your dependency problems (or causes others). If you want to collaborate with me on getting a wider selection of packages into the list, be in touch as well.</p>
<h2 id="future-enhancements">Future enhancements</h2>